[supervisord]
nodaemon=true
logfile=/app/logs/supervisord.log
pidfile=/tmp/supervisord.pid
loglevel=info

# ── IB Gateway (headless) ────────────────────────────────────
[program:ibgateway]
command=/opt/ibgateway/start.sh
directory=/opt/ibgateway
autostart=true
autorestart=true
stdout_logfile=/app/logs/ibgateway.log
stderr_logfile=/app/logs/ibgateway_err.log
startsecs=10
startretries=3
priority=10

# ── Dashboard (Flask via Gunicorn) ───────────────────────────
# Railway provides PORT env var — we bind to it
[program:dashboard]
command=bash -c "gunicorn --bind 0.0.0.0:${PORT:-5000} --workers 2 --timeout 120 'dashboard.app:create_app()'"
directory=/app
autostart=true
autorestart=true
stdout_logfile=/app/logs/dashboard.log
stderr_logfile=/app/logs/dashboard_err.log
environment=PYTHONPATH="/app"
priority=20

# ── Trading Bot ──────────────────────────────────────────────
# Delayed start — wait for IB Gateway to initialize
[program:trading_bot]
command=bash -c "sleep 30 && python3 main.py"
directory=/app
autostart=true
autorestart=true
stdout_logfile=/app/logs/bot_stdout.log
stderr_logfile=/app/logs/bot_stderr.log
environment=PYTHONPATH="/app"
startretries=10
startsecs=35
priority=30
